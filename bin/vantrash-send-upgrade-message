#!/usr/bin/perl
use strict;
use warnings;
use lib 'lib';
use FindBin;
use Email::MIME;

use App::VanTrash::Email;
use App::VanTrash::Model;
use App::VanTrash::Config;

my $base_path = "$FindBin::Bin/..";
my $emailer = App::VanTrash::Email->new(base_path => $base_path);
my $model   = App::VanTrash::Model->new(base_path => $base_path);

my $reminders = $model->reminders->all;
my %seen_email;
my $subject = 'Changes to VanTrash - your action is required!';
for my $rem (@$reminders) {
    next unless $rem->{confirmed};
    next if $seen_email{$rem->{email}}++;

    my %headers = (
        From => '"VanTrash" <noreply@vantrash.ca>',
        To => $rem->{email},
        Subject => $subject,
    );
    (my $cur_target = $rem->{target}) =~ s/:.+//;
    my $do_nothing_message;
    if ($cur_target eq 'twitter') {
        $do_nothing_message = <<EOT;
If you take no action, we will migrate your twitter reminder over to
recollect.net at the end of February 2011 when the new Garbage Schedule takes
effect.  However, you will need to follow the \@recollectnet twitter user, who
will be the one reminding you with direct messages.

Follow \@recollectnet now to avoid any interruption:

  http://twitter.com/recollectnet
EOT
    }
    else {
        $do_nothing_message = <<EOT;
If you take no action, we will migrate your email reminder over to
recollect.net at the end of February 2011 when the new Garbage Schedule takes
effect.
EOT
    }

    my $migrate_url = App::VanTrash::Config->base_url . '/migrate/' . $rem->{id};
    my $email = Email::MIME->create(
        attributes => {
            content_type => 'text/plain',
            disposition => 'inline',
            charset => 'utf8',
        },
        body => <<EOT,
Dear Vantrash User,

20 months ago we launched VanTrash to help Vancouver's citizens remember to take their garbage and recycling out. Since then we've watched our user base grow to over 3000 citizens (that we know of!). Thank you for making Vantrash a huge success and a ton of fun.

We're emailing you because we have 3 quick messages:

<b>1. Today, we're proud to introduce VanTrash's successor: Recollect.net.</b>

Recollect has the same reminders as VanTrash but has been re-built to work in many cities and - for a small fee - features Text Message and Phone Call notifications! (Email and iCal remain free)

To migrate your VanTrash reminder to Recollect click the following link:

http://vantrash.ca:2009/migrate/4C2CEB91-B8D8-359F-BE45-481A285BF7EC

If you take no action, we will migrate your email reminder over to recollect.net at the end of February 2011 when the new Garbage Schedule takes effect.

<b>2. More Cities</b>

Still more exciting, <a href=http://recollect.net/>Recollect</a> will also be expanding to other cities, making life just a little bit easier for even more citizens. So far we have added North Vancouver and Victoria (including Oak Bay and Esquimalt) with more (Edmonton, Toronto) to come.

<b>3. Let a Friend Know</b>

We hope that you've found our service so helpful that you'll be willing to tell your friends and family about Recollect.net. Please try our <a href=http://recollect.net/tell-a-friend>Tell a Friend Service</a>, or even buy a parent or grandparent a Text Message subscription! You can also <a href=http://twitter.com/#%21/recollectnet>follow us on Twitter</a> and <a href=http://www.facebook.com/pages/recollectnet/194196287264770>join our Facebook page</a>.

If you have any feedback for us please send it to feedback@recollect.net.

Thanks,
The VanTrash / Recollect Team - Kevin, David and Luke.

http://recollect.net
EOT
    );
    $email->header_set( $_ => $headers{$_}) for keys %headers;
    print "Sending email to $rem->{email} about $rem->{id}\n";
    $emailer->mailer->send($email);
    sleep 2;
}

exit;

