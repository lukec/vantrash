#!/usr/bin/perl
use strict;
use warnings;
use lib 'lib';
use FindBin;
use Email::MIME;

use App::VanTrash::Email;
use App::VanTrash::Model;
use App::VanTrash::Config;

my $base_path = "$FindBin::Bin/..";
my $emailer = App::VanTrash::Email->new(base_path => $base_path);
my $model   = App::VanTrash::Model->new(base_path => $base_path);

my $reminders = $model->reminders->all;
my %seen_email;
my $subject = 'Changes to VanTrash - your action is required!';
for my $rem (@$reminders) {
    next unless $rem->{confirmed};
    next if $seen_email{$rem->{email}}++;

    my %headers = (
        From => '"VanTrash" <noreply@vantrash.ca>',
        To => $rem->{email},
        Subject => $subject,
    );
    (my $cur_target = $rem->{target}) =~ s/:.+//;
    my $do_nothing_message;
    if ($cur_target eq 'twitter') {
        $do_nothing_message = <<EOT;
If you take no action, we will migrate your twitter reminder over to
recollect.net at the end of February 2011 when the new Garbage Schedule takes
effect.  However, you will need to follow the \@recollectnet twitter user, who
will be the one reminding you with direct messages.

Follow \@recollectnet now to avoid any interruption:

  http://twitter.com/recollectnet
EOT
    }
    else {
        $do_nothing_message = <<EOT;
If you take no action, we will migrate your email reminder over to
recollect.net at the end of February 2011 when the new Garbage Schedule takes
effect.
EOT
    }

    my $migrate_url = App::VanTrash::Config->base_url . '/migrate/' . $rem->{id};
    my $email = Email::MIME->create(
        attributes => {
            content_type => 'text/plain',
            disposition => 'inline',
            charset => 'utf8',
        },
        body => <<EOT,
20 months ago we launched VanTrash to help Vancouver's citizens remember to
take their garbage and recycling out.  Since then we have watched our user
base grow to over 3000 citizens (that we know of!).

We're proud to introduce VanTrash's successor: Recollect.net

Recollect has the same reminders that VanTrash has but has been re-built to
support many cities and now features handy Text Message and Phone Call 
notifications!

To migrate your VanTrash reminder to Recollect click the following link:

  $migrate_url

$do_nothing_message

Still more exciting, Recollect will also be expanding to other cities,
making life just a little bit easier for even more citizens.  So far we have
added North Vancouver and Victoria (including Oak Bay and Esquimalt), and
there are more to come.

We hope that Recollect continues to be a useful service to you and that
you'll continue to tell your friends and family about Recollect.net!

If you have any feedback for us please send it to feedback\@recollect.net.

Thanks,
The VanTrash / Recollect Team - Kevin, David and Luke.

http://recollect.net
EOT
    );
    $email->header_set( $_ => $headers{$_}) for keys %headers;
    print "Sending email to $rem->{email} about $rem->{id}\n";
    $emailer->mailer->send($email);
    sleep 2;
}

exit;

